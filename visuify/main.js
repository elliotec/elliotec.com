function addToGraph(t,n,e,r){return e.id=n.name,r.target=n.name,t.nodes.push(e),t.links.push(r),t}function buildGraph(t,n,e){var r=e||{nodes:[{id:t.name,uri:t.uri}],links:[]};return r=n.reduce(function(n,e){var i={id:e.name,uri:e.uri},a={source:t.name};return addToGraph(r,e,i,a)},r)}function getRelatedArtists(t){return $.ajax({url:"https://api.spotify.com/v1/artists/"+t+"/related-artists"})}function getArtist(t){return $.ajax({url:"https://api.spotify.com/v1/search",data:{q:t,type:"artist"}})}function drawGraph(t){function n(){d.attr("x1",function(t){return t.source.x}).attr("y1",function(t){return t.source.y}).attr("x2",function(t){return t.target.x}).attr("y2",function(t){return t.target.y}),l.attr("cx",function(t){return t.x}).attr("cy",function(t){return t.y})}function e(t){d3.event.active||u.alphaTarget(.3).restart(),t.fx=t.x,t.fy=t.y}function r(t){t.fx=d3.event.x,t.fy=d3.event.y}function i(t){d3.event.active||u.alphaTarget(0),t.fx=null,t.fy=null}var a=d3.select("svg"),o=+a.attr("width"),s=+a.attr("height"),u=d3.forceSimulation().force("link",d3.forceLink().id(function(t){return t.id})).force("charge",d3.forceManyBody().strength(-80)).force("center",d3.forceCenter(o/2,s/2)),c=d3.select("body").append("div").attr("class","tooltip").style("opacity",0),d=a.append("g").attr("class","links").selectAll("line").data(t.links).enter().append("line").attr("stroke-width",2).on("mouseover",function(t){c.transition().duration(200).style("opacity",.9),c.html(t.source.id+" --- "+t.target.id).style("left",d3.event.pageX+"px").style("top",d3.event.pageY-28+"px")}).on("mouseout",function(){c.transition().duration(500).style("opacity",0)}),l=a.append("g").attr("class","nodes").selectAll("circle").data(t.nodes).enter().append("circle").attr("r",8).attr("fill","#12121").on("mouseover",function(t){d3.select(this).transition().duration(200).attr("r",14),c.transition().duration(200).style("opacity",.9),c.html(t.id).style("left",d3.event.pageX+"px").style("top",d3.event.pageY-28+"px")}).on("mouseout",function(){d3.select(this).transition().duration(200).attr("r",8),c.transition().duration(500).style("opacity",0)}).on("click",function(t){$("#query").val(t.id),c.transition().duration(500).style("opacity",0),chain(),window.location.href=t.uri}).call(d3.drag().on("start",e).on("drag",r).on("end",i));u.nodes(t.nodes).on("tick",n),u.force("link").links(t.links)}function chain(){$("svg").empty(),$("h3").text($("#query").val()),getArtist($("#query").val()).then(function(t){var n=t.artists.items[0];return $.when(n,getRelatedArtists(n.id).then(function(t){return t.artists}))}).then(function(t,n){return $.when(buildGraph(t,n),n)}).then(function(t,n){var e=[$.when(t)];return n.forEach(function(t){var n=$.Deferred();e.push(n),getRelatedArtists(t.id).then(function(e){var r={};r[t.name]=e.artists,n.resolve(r)})}),$.when.apply(null,e)}).then(function(t){var n=t,e=Array.prototype.slice.call(arguments,1);return e.forEach(function(e){n=buildGraph({name:Object.keys(e)[0]},e[Object.keys(e)[0]],t)}),n}).then(function(t){t.nodes=_.uniqBy(t.nodes,"id"),drawGraph(t)})}$("#submit").on("click",function(t){t.preventDefault(),chain()});